# 🗺️ 导航系统 - 防卡住机制

## ⚠️ 常见卡住问题

### 问题1: 进入游戏后无法到达红门
**原因**：
- 角色初始位置随机
- 可能被NPC/其他玩家/地形挡住
- 直接传送可能失败

### 问题2: 传送路径被障碍物阻挡
**原因**：
- 固定路径可能遇到怪物
- 地形障碍
- 传送位置不可达

## ✅ 已实现的防卡机制

### 1️⃣ 城镇到红门智能导航

**方法A: 预设路径（推荐）**
```json
{
  "town_to_portal_path": [
    [960, 520],  // 点1：城镇中心
    [920, 500],  // 点2：中间过渡点
    [880, 480]   // 点3：红门附近
  ]
}
```

**工作流程**：
```
1. 进入游戏后，从初始位置开始
2. 按顺序传送到3个点
3. 每个点随机偏移±5像素（避免卡住）
4. 第一次传送延迟0.4秒（确保加载完成）
5. 后续传送延迟0.3秒
```

**方法B: 智能靠近（备用）**
```python
如果未配置预设路径：
1. 计算红门位置
2. 传送到红门周围随机位置（偏移10-30像素）
3. 尝试3次不同位置
4. 避免直接传送到红门上（可能被卡）
```

### 2️⃣ 红门点击重试机制

**多次尝试策略**：
```python
尝试1: 点击红门位置（±5像素随机）
等待0.5秒
  ↓ 如果失败
尝试2: 移动到红门周围（±15像素）
       再次点击红门
等待0.5秒
  ↓ 如果失败
尝试3: 最后一次点击
等待2秒确认进入
```

### 3️⃣ Pindle传送路径防卡

**每个传送点的重试逻辑**：
```python
for 每个传送点:
    尝试1: 传送到目标点（±8像素）
    等待0.15-0.3秒
      ↓ 如果可能卡住
    尝试2: 增大偏移量（±12像素）
           尝试不同位置
    继续下一个点
```

## 📋 坐标配置说明

### 必须配置的坐标

**1. 城镇到红门路径** `town_to_portal_path`
```json
{
  "town_to_portal_path": [
    [960, 520],   // 第1个传送点
    [920, 500],   // 第2个传送点
    [880, 480]    // 第3个传送点（红门附近）
  ]
}
```

**如何获取**：
1. 运行游戏，角色站在初始出生位置
2. 运行 `get_coords_simple.py`
3. 移动鼠标到你想传送的3个点
4. 记录坐标

**推荐路径**：
- 点1：出生点或城镇中心安全位置
- 点2：红门和出生点之间的中间位置
- 点3：红门正前方（不要直接在门上）

**2. 红门精确位置** `red_portal_position`
```json
{
  "red_portal_position": [880, 480]
}
```

**如何获取**：
1. 角色靠近红门
2. 移动鼠标到红门中心
3. 记录坐标

**3. Pindle神殿传送路径** `teleport_path`
```json
{
  "teleport_path": [
    [960, 450],   // 从红门出来后的第1个传送点
    [960, 380],   // 走廊中段
    [960, 350]    // Pindle神殿入口
  ]
}
```

## 🎯 配置获取步骤

### 步骤1: 获取城镇路径
```bash
python get_coords_simple.py
```

1. **启动游戏，进入哈洛加斯**
2. 角色站在初始位置
3. 记录3个点：

```
点1 - 出生点/中心: [960, 520]
点2 - 中间位置: [920, 500]
点3 - 红门附近: [880, 480]
```

### 步骤2: 获取红门坐标
1. 角色走到红门旁边
2. 移动鼠标到红门中心
3. 记录：`[880, 480]`

### 步骤3: 获取神殿路径
1. 手动进入红门
2. 记录从红门到Pindle的3个传送点：

```
点1 - 红门出来: [960, 450]
点2 - 走廊中段: [960, 380]
点3 - 神殿入口: [960, 350]
```

### 步骤4: 更新到config.json
```json
{
  "coordinates": {
    "in_game": {
      "red_portal_position": [880, 480]
    },
    "town_to_portal_path": [
      [960, 520],
      [920, 500],
      [880, 480]
    ],
    "teleport_path": [
      [960, 450],
      [960, 380],
      [960, 350]
    ]
  }
}
```

## 🔧 高级配置

### 防卡设置
```json
{
  "sorceress": {
    "navigation": {
      "max_teleport_retries": 2,        // 每个点最多重试次数
      "stuck_detection": true,          // 启用卡住检测
      "alternative_path_on_fail": true  // 失败时尝试备用路径
    }
  }
}
```

### 延迟调整
```json
{
  "sorceress": {
    "teleport_delay": 0.15,  // 传送基础延迟
    "cast_delay": 0.25       // 施法延迟
  }
}
```

**如果经常卡住**：
- 增加 `teleport_delay` 到 0.20-0.25
- 增加路径点数量（5-7个点）
- 增大随机偏移范围

## 🐛 故障排除

### 问题1: 无法到达红门
**症状**：角色传送后没有移动

**解决方案**：
1. 检查 `town_to_portal_path` 坐标是否正确
2. 增加路径点数量（3个 → 5个）
3. 手动测试每个点是否可达

**测试方法**：
```python
# 手动传送测试
按右键传送到 [960, 520]
等待1秒
按右键传送到 [920, 500]
等待1秒
按右键传送到 [880, 480]
```

### 问题2: 无法进入红门
**症状**：点击红门没有反应

**解决方案**：
1. 调整 `red_portal_position` 坐标
2. 确保角色足够靠近红门
3. 增加点击重试次数

### 问题3: 传送到Pindle时卡住
**症状**：传送路径中断

**解决方案**：
1. 重新获取 `teleport_path` 坐标
2. 增加中间过渡点
3. 增大随机偏移量（8 → 12）

### 问题4: 角色在城镇乱跑
**症状**：路径点设置不合理

**解决方案**：
```json
// 确保路径点是递进的
"town_to_portal_path": [
  [960, 540],  // 不要离初始位置太远
  [940, 510],  // 逐步靠近
  [920, 490],  // 继续靠近
  [900, 480],  // 接近红门
  [880, 480]   // 红门位置
]
```

## 📊 路径优化建议

### 方案A: 简单路径（3点）
```json
{
  "town_to_portal_path": [
    [960, 520],
    [920, 500],
    [880, 480]
  ]
}
```
✅ 优点：快速
⚠️ 缺点：可能被卡

### 方案B: 安全路径（5点）
```json
{
  "town_to_portal_path": [
    [960, 540],
    [950, 520],
    [930, 500],
    [900, 485],
    [880, 480]
  ]
}
```
✅ 优点：更稳定
⚠️ 缺点：稍慢

### 方案C: 弧形路径（避开障碍）
```json
{
  "town_to_portal_path": [
    [960, 520],
    [940, 510],
    [920, 505],  // 绕开中间的NPC/障碍
    [900, 495],
    [880, 480]
  ]
}
```
✅ 优点：避开固定障碍物

## 🎯 最佳实践

1. **路径点不要太密集**
   - 间隔至少20-30像素
   - 避免传送动画重叠

2. **避开已知障碍**
   - NPC位置
   - 地形凸起
   - 其他固定障碍

3. **终点不要太精确**
   - 红门附近即可，不需要直接在门上
   - 留出10-20像素误差空间

4. **定期测试路径**
   - 手动运行测试10次
   - 确保成功率>95%

5. **根据FCR调整延迟**
   - FCR越高，延迟可以越短
   - 保证传送完成再继续下一步

---

**记住**：好的路径配置是成功的关键！花时间获取准确坐标能避免90%的卡住问题。🗺️✨
